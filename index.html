<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Will AR - Laboratorio Matem√°tico</title>
<!-- AR.js ACTUALIZADO + FIXES CR√çTICOS -->
<script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ar-js-org@3.4.4/aframe/build/aframe-ar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
/* ... (mant√©n tu CSS existente, sin cambios) ... */
#camera-permission {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
z-index: 9999;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
color: white;
padding: 20px;
text-align: center;
}
.permission-icon {
font-size: 4rem;
margin-bottom: 20px;
color: #3498db;
}
.permission-title {
font-size: 1.8rem;
margin-bottom: 15px;
color: #ecf0f1;
}
.permission-text {
font-size: 1.1rem;
color: #bdc3c7;
max-width: 80%;
line-height: 1.6;
margin-bottom: 30px;
}
.btn-permission {
background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
color: white;
border: none;
padding: 16px 40px;
font-size: 1.2rem;
border-radius: 15px;
cursor: pointer;
font-weight: bold;
box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
transition: all 0.3s;
}
.btn-permission:active {
transform: scale(0.95);
box-shadow: 0 3px 10px rgba(46, 204, 113, 0.4);
}
#https-warning {
background: #e74c3c;
color: white;
padding: 15px;
text-align: center;
font-weight: bold;
border-radius: 10px;
margin: 15px 0;
display: none;
}
</style>
</head>
<body>
<!-- NUEVO: Pantalla de permisos de c√°mara -->
<div id="camera-permission">
<div class="permission-icon">üì∏</div>
<h2 class="permission-title">Permiso de C√°mara Requerido</h2>
<p class="permission-text">Esta aplicaci√≥n necesita acceso a tu c√°mara para mostrar objetos 3D en Realidad Aumentada. Tu c√°mara solo se usa localmente y no se almacena ni transmite ninguna imagen.</p>
<button class="btn-permission" onclick="solicitarPermisos()">‚úÖ Permitir Acceso a C√°mara</button>
<div id="https-warning">‚ö†Ô∏è ERROR: Esta app requiere HTTPS para funcionar en m√≥viles. Abre desde https:// o usa localhost</div>
</div>

<!-- ... (mant√©n tu HTML existente: loading-screen, menu-overlay, ar-controls, etc.) ... -->

<script>
// ===== FIXES CR√çTICOS =====
let texturaData = null;
let figuraSeleccionada = "box";
let arActivo = false;
let reglaVisible = true;
let escalaActual = 1;
let markerDetected = false;
let rotacionActiva = true;
let sceneLoaded = false;
let cameraStream = null; // Para gestionar el stream de c√°mara

// Verificaci√≥n HTTPS CR√çTICA (antes de cualquier cosa)
if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
document.getElementById('https-warning').style.display = 'block';
document.querySelector('.btn-permission').disabled = true;
document.querySelector('.btn-permission').innerText = '‚ùå Requiere HTTPS';
console.error('‚ùå ERROR: La c√°mara solo funciona en HTTPS o localhost');
}

// ===== SOLICITAR PERMISOS EXPL√çCITOS =====
async function solicitarPermisos() {
try {
// Solicitar permisos de c√°mara ANTES de cargar AR.js
const stream = await navigator.mediaDevices.getUserMedia({ 
video: { 
facingMode: 'environment',
width: { ideal: 1280 },
height: { ideal: 720 }
} 
});
cameraStream = stream;
// Detener el stream temporalmente (AR.js lo reiniciar√°)
stream.getTracks().forEach(track => track.stop());
console.log('‚úÖ Permisos de c√°mara concedidos');
document.getElementById('camera-permission').style.display = 'none';
} catch (err) {
console.error('‚ùå Error permisos c√°mara:', err);
alert(`Error al acceder a la c√°mara:\n${err.name}\n\nSoluciones:\n1. Usa HTTPS (https://)\n2. Recarga y permite permisos\n3. Verifica que la c√°mara no est√© en uso\n4. En iOS: Configuraci√≥n > Safari > C√°mara: Permitir`);
}
}

// ===== INICIAR AR CON FIXES =====
function iniciarAR() {
if (!cameraStream && location.protocol !== 'https:' && location.hostname !== 'localhost') {
alert('‚ö†Ô∏è Necesitas HTTPS para usar la c√°mara en m√≥viles');
return;
}

console.log('üé¨ Iniciando AR con configuraci√≥n segura...');
document.getElementById('ar-scene-container').style.display = 'block';
document.getElementById('menu-overlay').style.transform = "translateY(-100%)";
document.getElementById('ar-controls').style.display = "block";
document.getElementById('camera-status').style.display = 'block';

// FIX CR√çTICO: Configuraci√≥n de AR.js optimizada para m√≥viles
const scene = document.querySelector('a-scene');
if (!scene.hasLoaded) {
scene.addEventListener('loaded', () => {
console.log('‚úÖ Escena A-Frame cargada');
inicializarAR();
});
} else {
inicializarAR();
}
}

function inicializarAR() {
sceneLoaded = true;
if (texturaData) {
document.getElementById('textura-asset').setAttribute('src', texturaData);
}
crearFigura3D();
actualizarInfoFigura();
actualizarMediciones();

// FIX: Escuchar eventos de marcador con mejor detecci√≥n
const marker = document.querySelector('#hiro-marker');
if (marker) {
marker.addEventListener('markerFound', () => {
markerDetected = true;
console.log('‚úÖ MARCADOR DETECTADO');
const statusText = document.getElementById('camera-status-text');
statusText.textContent = '‚úÖ ¬°Objeto 3D visible!';
statusText.className = 'status-active';
setTimeout(() => {
document.getElementById('camera-status').style.display = 'none';
}, 2500);
});

marker.addEventListener('markerLost', () => {
markerDetected = false;
const statusText = document.getElementById('camera-status-text');
statusText.textContent = 'üîç Buscando marcador HIRO...';
statusText.className = 'status-searching';
document.getElementById('camera-status').style.display = 'block';
});
}

// FIX: Timeout de fallback si no se detecta marcador en 15s
setTimeout(() => {
if (!markerDetected && arActivo) {
const statusText = document.getElementById('camera-status-text');
statusText.textContent = '‚ùì ¬øProblemas? Ilumina mejor el marcador o recarga';
statusText.className = 'status-searching';
}
}, 15000);

arActivo = true;
}

// ===== CREAR FIGURA CON FIX DE CORS =====
function crearFigura3D() {
const contenedor = document.getElementById('contenedor-principal');
['modelo-3d', 'wireframe-guia'].forEach(id => {
const el = document.getElementById(id);
if (el) el.remove();
});

const modelo = document.createElement('a-entity');
modelo.setAttribute('id', 'modelo-3d');
modelo.setAttribute('position', '0 0.5 0');

// FIX CORS: Usar textura p√∫blica sin restricciones
const texturaPublica = 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/cube/skyboxsun25deg/px.jpg';
let materialParams = texturaData 
? `src: #textura-asset; metalness: 0.3; roughness: 0.5; side: double`
: `color: #4ECDC4; metalness: 0.3; roughness: 0.5; side: double`;

// Configuraci√≥n por figura
const configs = {
box: { primitive: 'box', width: 1, height: 1, depth: 1, rotation: '0 45 0' },
sphere: { primitive: 'sphere', radius: 0.5, segmentsWidth: 32, segmentsHeight: 32, rotation: '0 0 0' },
cylinder: { primitive: 'cylinder', radius: 0.5, height: 1.5, rotation: '0 0 0' },
cone: { primitive: 'cone', radiusBottom: 0.5, radiusTop: 0, height: 1.5, rotation: '0 0 0' },
torus: { primitive: 'torus', radius: 0.5, radiusTubular: 0.15, segmentsRadial: 24, rotation: '0 45 0' },
tetrahedron: { primitive: 'tetrahedron', radius: 0.6, rotation: '0 45 0' },
dodecahedron: { primitive: 'dodecahedron', radius: 0.5, rotation: '0 45 0' },
icosahedron: { primitive: 'icosahedron', radius: 0.5, rotation: '0 45 0' },
octahedron: { primitive: 'octahedron', radius: 0.6, rotation: '0 45 0' }
};

const config = configs[figuraSeleccionada] || configs.box;
modelo.setAttribute('geometry', Object.entries(config)
.filter(([k]) => k !== 'rotation')
.map(([k, v]) => `${k}: ${v}`).join('; '));
modelo.setAttribute('rotation', config.rotation);
modelo.setAttribute('material', materialParams);

if (rotacionActiva) {
modelo.setAttribute('animation', 'property: rotation; to: 0 405 0; dur: 10000; loop: true; easing: linear');
}

// Wireframe gu√≠a
const wireframe = document.createElement('a-entity');
wireframe.setAttribute('id', 'wireframe-guia');
wireframe.setAttribute('geometry', modelo.getAttribute('geometry'));
wireframe.setAttribute('material', 'wireframe: true; color: #FFE66D; opacity: 0.8; side: double');
wireframe.setAttribute('scale', '1.05 1.05 1.05');
wireframe.setAttribute('rotation', config.rotation);
wireframe.setAttribute('position', '0 0.5 0');

contenedor.appendChild(modelo);
contenedor.appendChild(wireframe);
console.log('‚úÖ Figura 3D creada:', figuraSeleccionada);
}

// ===== SALIR CON LIMPIEZA DE RECURSOS =====
function salirAR() {
if (confirm('¬øVolver al men√∫ principal?')) {
// Limpiar recursos de c√°mara
try {
const video = document.querySelector('video');
if (video && video.srcObject) {
video.srcObject.getTracks().forEach(track => track.stop());
video.srcObject = null;
}
} catch (e) { console.log('Limpiando c√°mara:', e); }

// Recargar app limpia
location.reload();
}
}

// ===== EVENTOS ADICIONALES =====
window.addEventListener('beforeunload', () => {
if (cameraStream) {
cameraStream.getTracks().forEach(track => track.stop());
}
});

// Bloquear gestos que rompen AR
['gesturestart', 'gesturechange', 'gestureend'].forEach(event => {
document.addEventListener(event, e => e.preventDefault());
});
</script>
</body>
</html>
