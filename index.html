<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>WILL AR - Laboratorio Matem√°tico</title>

<!-- LIBRER√çAS -->
<script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/3.4.3/aframe/build/aframe-ar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  overflow: hidden;
  font-family: 'Segoe UI', sans-serif;
  background-color: #000;
  width: 100vw;
  height: 100vh;
  position: fixed;
  touch-action: manipulation;
  overscroll-behavior: none;
}

#init-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  padding: 20px;
  text-align: center;
}

#init-screen.hidden {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s;
}

.init-logo {
  font-size: 3rem;
  margin-bottom: 15px;
  color: #3498db;
}

.init-title {
  font-size: 2rem;
  color: #ecf0f1;
  margin-bottom: 10px;
  font-weight: 700;
}

.init-desc {
  max-width: 85%;
  color: #bdc3c7;
  line-height: 1.6;
  margin: 15px 0 25px 0;
}

.btn-start {
  background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
  color: white;
  border: none;
  padding: 16px 40px;
  font-size: 1.3rem;
  border-radius: 15px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
  margin-top: 15px;
  min-width: 260px;
  transition: all 0.2s;
}

#https-warning {
  background: #e74c3c;
  color: white;
  padding: 12px;
  border-radius: 8px;
  margin: 20px 0;
  font-weight: bold;
  display: none;
}

#menu-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #2c3e50 0%, #0a0a15 100%);
  z-index: 9998;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  color: white;
  overflow-y: auto;
}

.card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  padding: 25px;
  border-radius: 18px;
  width: 95%;
  max-width: 420px;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
  margin-bottom: 20px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
}

label {
  display: block;
  text-align: left;
  margin-top: 15px;
  margin-bottom: 8px;
  color: #ecf0f1;
  font-size: 0.9rem;
  font-weight: 500;
}

select, input[type="range"] {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: rgba(255, 255, 255, 0.12);
  color: white;
  outline: none;
}

input[type="range"] {
  padding: 0;
  height: 30px;
  accent-color: #3498db;
}

.file-input-wrapper {
  position: relative;
  width: 100%;
  margin-top: 10px;
}

.file-input-wrapper input[type="file"] {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  z-index: 10;
}

.file-input-label {
  display: block;
  width: 100%;
  padding: 12px;
  background: rgba(142, 68, 173, 0.85);
  color: white;
  border-radius: 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.95rem;
  font-weight: 500;
}

button {
  width: 100%;
  padding: 13px;
  margin-top: 15px;
  border-radius: 10px;
  border: none;
  font-size: 1.05rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-gen {
  background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
  color: white;
}

.btn-start-ar {
  background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
  color: white;
  font-size: 1.25rem;
  display: none;
  margin-top: 20px;
  padding: 15px;
}

.btn-back {
  background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
  color: white;
  padding: 10px 25px;
  font-size: 0.95rem;
  width: auto;
  display: inline-block;
  min-width: 120px;
  margin-top: 15px;
}

#ar-scene-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
  display: none;
}

#camera-status {
  position: fixed;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(10, 10, 20, 0.92);
  color: #f39c12;
  padding: 10px 20px;
  border-radius: 25px;
  font-size: 1rem;
  z-index: 1001;
  border: 2px solid #f39c12;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  font-weight: 600;
  backdrop-filter: blur(10px);
  max-width: 90%;
  text-align: center;
  display: none;
}

.status-ok {
  color: #27ae60 !important;
  border-color: #27ae60 !important;
}

#controls {
  position: fixed;
  bottom: 15px;
  left: 0;
  width: 100%;
  z-index: 1000;
  text-align: center;
  padding: 0 15px;
  display: none;
}

.controls-wrapper {
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 12px;
  background: rgba(10, 10, 20, 0.85);
  padding: 12px 20px;
  border-radius: 25px;
  border: 2px solid rgba(52, 152, 219, 0.3);
  backdrop-filter: blur(10px);
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
}

.scale-row {
  display: flex;
  align-items: center;
  gap: 10px;
  color: white;
  font-size: 0.9rem;
}

.action-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.btn-control {
  background: rgba(52, 152, 219, 0.9);
  color: #fff;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.4rem;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

#exit-btn {
  position: fixed;
  top: 15px;
  right: 15px;
  background: rgba(231, 76, 60, 0.9);
  color: #fff;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: none;
  font-size: 1.4rem;
  z-index: 1002;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  cursor: pointer;
  display: none;
  transition: all 0.2s;
}

#preview {
  max-width: 100%;
  max-height: 150px;
  margin-top: 10px;
  border-radius: 8px;
  display: none;
}

.info-section {
  background: rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 10px;
  margin: 15px;
  max-width: 450px;
  font-size: 0.85rem;
  line-height: 1.6;
  text-align: left;
}

.info-section a {
  color: #3498db;
  text-decoration: underline;
  font-weight: bold;
}

#medidas-display {
  margin-top: 10px;
  background: rgba(0, 0, 0, 0.5);
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #3498db;
  font-size: 0.9rem;
}
</style>
</head>
<body>

<!-- PANTALLA INICIAL -->
<div id="init-screen">
  <div class="init-logo">üî¨</div>
  <h1 class="init-title">WILL AR</h1>
  <p class="init-desc">
    Laboratorio Matem√°tico de Realidad Aumentada<br>
    Configura tu figura y apunta al marcador
  </p>
  <div id="https-warning">
    ‚ö†Ô∏è Requiere HTTPS para funcionar en m√≥viles
  </div>
  <button class="btn-start" id="start-btn">‚úÖ COMENZAR</button>
  <div class="info-section">
    <strong>üìå Instrucciones:</strong><br><br>
    1. Configura tu figura y textura<br>
    2. Presiona "INICIAR AR"<br>
    3. <strong>Permite el permiso</strong> de c√°mara cuando se pida<br>
    4. Descarga e imprime el <strong>marcador HIRO</strong><br>
    5. Apunta la c√°mara al marcador<br><br>
    <a href="https://raw.githack.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank">
      üëâ Descargar marcador HIRO (A4)
    </a>
  </div>
</div>

<!-- MEN√ö DE CONFIGURACI√ìN -->
<div id="menu-overlay">
  <div class="card">
    <h2 style="color: #3498db; margin-bottom: 15px;">‚öôÔ∏è CONFIGURACI√ìN</h2>
    
    <label>üé® Textura (Opcional)</label>
    <div class="file-input-wrapper">
      <input type="file" id="imgUpload" accept="image/jpeg,image/png,image/jpg">
      <label for="imgUpload" class="file-input-label">üìÅ Seleccionar Imagen</label>
    </div>
    <img id="preview" alt="Vista previa">
    
    <label>üî∑ Figura Geom√©trica</label>
    <select id="figura">
      <option value="box">üì¶ Cubo</option>
      <option value="sphere">‚öΩ Esfera</option>
      <option value="cylinder">üõ¢Ô∏è Cilindro</option>
      <option value="cone">üî∫ Cono</option>
      <option value="torus">üç© Toroide</option>
    </select>
    
    <button class="btn-gen" onclick="generarConfig()">‚öôÔ∏è CONFIGURAR</button>
    <button class="btn-start-ar" id="btn-iniciar-ar" onclick="iniciarAR()">üöÄ INICIAR AR</button>
    <button class="btn-back" onclick="volverInicio()">üîô Volver</button>
  </div>
</div>

<!-- ESCENA AR -->
<div id="ar-scene-container"></div>

<!-- CONTROLES AR -->
<div id="controls">
  <div class="controls-wrapper">
    <!-- CONTROL DE ESCALA (TAMA√ëO) -->
    <div class="scale-row">
      <span>üìè Tama√±o:</span>
      <input type="range" id="scale-slider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="cambiarEscala(this.value)">
      <span id="scale-val">1.0x</span>
    </div>
    
    <!-- MEDICIONES DIGITALES -->
    <div id="medidas-display">
      üìê H: <strong id="med-h">100</strong>cm | 
      A: <strong id="med-w">100</strong>cm | 
      P: <strong id="med-d">100</strong>cm
    </div>

    <!-- BOTONES DE ACCI√ìN -->
    <div class="action-buttons">
      <button class="btn-control" onclick="toggleRotacion()" title="Rotaci√≥n">‚è∏Ô∏è</button>
      <button class="btn-control" onclick="toggleRegla()" title="Ver Regla">üìê</button>
      <button class="btn-control" onclick="salirAR()" title="Salir">‚úï</button>
    </div>
  </div>
</div>

<!-- BOT√ìN SALIDA R√ÅPIDA -->
<button id="exit-btn" onclick="salirAR()">‚úï</button>

<!-- ESTADO -->
<div id="camera-status">üîç Buscando marcador HIRO...</div>

<script>
let texturaData = null;
let figuraSeleccionada = "box";
let escalaActual = 1.0;
let rotacionActiva = true;
let reglaVisible = true;
let sceneLoaded = false;

// DATOS DE DIMENSIONES BASE (cm)
const dimensionesBase = {
  box: { h: 100, w: 100, d: 100 },
  sphere: { h: 160, w: 160, d: 160 },
  cylinder: { h: 200, w: 100, d: 100 },
  cone: { h: 200, w: 100, d: 100 },
  torus: { h: 40, w: 200, d: 200 }
};

// INICIO
window.addEventListener('load', () => {
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    document.getElementById('https-warning').style.display = 'block';
  }
});

document.getElementById('start-btn').addEventListener('click', () => {
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('‚ö†Ô∏è Requiere HTTPS');
    return;
  }
  document.getElementById('init-screen').classList.add('hidden');
  setTimeout(() => {
    document.getElementById('menu-overlay').style.display = 'flex';
  }, 500);
});

// TEXTURA
document.getElementById('imgUpload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('Muy grande'); return; }
  
  const reader = new FileReader();
  reader.onload = function(event) {
    texturaData = event.target.result;
    document.getElementById('preview').src = texturaData;
    document.getElementById('preview').style.display = 'block';
  };
  reader.readAsDataURL(file);
});

function generarConfig() {
  figuraSeleccionada = document.getElementById('figura').value;
  document.getElementById('btn-iniciar-ar').style.display = 'block';
}

// --- INICIAR AR ---
function iniciarAR() {
  console.log('üé¨ Iniciando AR...');
  document.getElementById('menu-overlay').style.display = 'none';
  
  // 1. Inyectar Escena
  construirEscenaAR();
  
  document.getElementById('ar-scene-container').style.display = 'block';
  document.getElementById('controls').style.display = 'block';
  document.getElementById('exit-btn').style.display = 'block';
  document.getElementById('camera-status').style.display = 'block';
  
  // 2. Esperar a que A-Frame cargue
  setTimeout(() => {
    crearFiguraYRegla();
    configurarEventos();
    actualizarMediciones();
  }, 1500);
}

// --- PLANTILLA ESCENA (CON REGLA CONTENEDORA) ---
function construirEscenaAR() {
  const container = document.getElementById('ar-scene-container');
  container.innerHTML = `
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; precision: medium;"
      loading-screen="enabled: false"
      device-orientation-permission-ui="enabled: false"
      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
      
      <a-assets timeout="40000">
        <img id="textura-asset" crossorigin="anonymous" src="${texturaData ? texturaData : 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@dev/examples/textures/cube/skyboxsun25deg/px.jpg'}">
      </a-assets>
      
      <a-entity light="type: ambient; color: #FFF; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="1 2 1"></a-entity>
      
      <a-marker preset="hiro" id="hiro-marker" smooth="true" smoothCount="10">
        <a-entity id="contenedor-principal" position="0 0 0">
            <!-- Modelo 3D -->
            <a-entity id="modelo-3d" position="0 0.5 0"></a-entity>
            
            <!-- REGLA HOLOGR√ÅFICA COMPLETA -->
            <a-entity id="regla-virtual" visible="true">
                <!-- EJE ALTURA (Y) - CYAN NE√ìN -->
                <a-entity position="-0.6 0 0">
                    <a-cylinder radius="0.015" height="2.1" color="#00FFFF" material="shader: flat; emissive: #00FFFF; emissiveIntensity: 0.8; transparent: true; opacity: 0.7; side: double"></a-cylinder>
                    <!-- Marcas 0, 50, 100 -->
                    <a-box position="0 0 0" width="0.15" height="0.02" depth="0.02" color="#00FFFF" material="shader: flat; emissive: #00FFFF; opacity: 0.8"></a-box>
                    <a-text value="0" position="-0.2 0 0" scale="0.3 0.3 0.3" color="#00FFFF" align="right" shader="flat"></a-text>
                    
                    <a-box position="0 0.5 0" width="0.1" height="0.015" depth="0.015" color="#00FFFF"></a-box>
                    <a-text value="50cm" position="-0.25 0.5 0" scale="0.25 0.25 0.25" color="#00FFFF" align="right"></a-text>

                    <a-box position="0 1.0 0" width="0.15" height="0.02" depth="0.02" color="#00FFFF"></a-box>
                    <a-text value="100cm" position="-0.25 1.0 0" scale="0.25 0.25 0.25" color="#00FFFF" align="right"></a-text>
                    
                    <a-text value="ALTURA" position="-0.25 -1.1 0" align="right" color="#00FFFF" scale="0.3 0.3 0.3" shader="flat"></a-text>
                </a-entity>

                <!-- EJE ANCHO (X) - MAGENTA NE√ìN -->
                <a-entity position="0 -0.6 0">
                    <a-cylinder radius="0.015" height="2.1" color="#FF00FF" rotation="0 0 90" material="shader: flat; emissive: #FF00FF; emissiveIntensity: 0.8; transparent: true; opacity: 0.7; side: double"></a-cylinder>
                    <!-- Marcas -->
                    <a-box position="0 0 0" width="0.02" height="0.15" depth="0.02" color="#FF00FF"></a-box>
                    <a-text value="0" position="0 -0.25 0" scale="0.3 0.3 0.3" color="#FF00FF" align="center"></a-text>
                    
                    <a-box position="0.5 0 0" width="0.015" height="0.1" depth="0.015" color="#FF00FF"></a-box>
                    <a-text value="50cm" position="0.5 -0.25 0" scale="0.25 0.25 0.25" color="#FF00FF" align="center"></a-text>

                    <a-box position="1.0 0 0" width="0.02" height="0.15" depth="0.02" color="#FF00FF"></a-box>
                    <a-text value="100cm" position="1.0 -0.25 0" scale="0.25 0.25 0.25" color="#FF00FF" align="center"></a-text>
                    
                    <a-text value="ANCHO" position="0 -0.4 0" align="center" color="#FF00FF" scale="0.3 0.3 0.3"></a-text>
                </a-entity>

                <!-- EJE PROFUNDIDAD (Z) - LIMA NE√ìN -->
                <a-entity position="0.6 0 0">
                    <a-cylinder radius="0.015" height="2.1" color="#00FF00" rotation="0 90 90" material="shader: flat; emissive: #00FF00; emissiveIntensity: 0.8; transparent: true; opacity: 0.7; side: double"></a-cylinder>
                    <!-- Marcas -->
                    <a-box position="0 0 0" width="0.02" height="0.15" depth="0.02" color="#00FF00"></a-box>
                    
                    <a-box position="0 0 0.5" width="0.015" height="0.1" depth="0.015" color="#00FF00"></a-box>
                    <a-text value="50cm" position="0 -0.25 0.5" scale="0.25 0.25 0.25" color="#00FF00" align="center"></a-text>

                    <a-box position="0 0 1.0" width="0.02" height="0.15" depth="0.02" color="#00FF00"></a-box>
                    <a-text value="100cm" position="0 -0.25 1.0" scale="0.25 0.25 0.25" color="#00FF00" align="center"></a-text>
                    
                    <a-text value="PROF" position="0 -0.4 0" align="center" color="#00FF00" scale="0.3 0.3 0.3"></a-text>
                </a-entity>
            </a-entity>
        </a-entity>
      </a-marker>
    </a-scene>
  `;
  sceneLoaded = true;
}

// --- CREAR FIGURA Y APLICAR ESCALA INICIAL ---
function crearFiguraYRegla() {
  const contenedor = document.getElementById('contenedor-principal');
  if(!contenedor) return;
  
  // Crear entidad 3D (se limpia y recrea si es necesario, pero aqu√≠ solo la creamos una vez)
  const modelo = document.createElement('a-entity');
  modelo.setAttribute('id', 'modelo-3d');
  modelo.setAttribute('position', '0 0.5 0');
  
  let geo = '';
  let rot = '0 45 0';
  switch(figuraSeleccionada) {
    case 'box': geo = 'primitive: box; width: 1; height: 1; depth: 1'; break;
    case 'sphere': geo = 'primitive: sphere; radius: 0.5'; rot='0 0 0'; break;
    case 'cylinder': geo = 'primitive: cylinder; radius: 0.5; height: 1.5'; break;
    case 'cone': geo = 'primitive: cone; radiusBottom: 0.5; height: 1.5'; break;
    case 'torus': geo = 'primitive: torus; radius: 0.5; radiusTubular: 0.15'; break;
  }
  
  modelo.setAttribute('geometry', geo);
  modelo.setAttribute('material', 'src: #textura-asset; metalness: 0.3; roughness: 0.5');
  modelo.setAttribute('rotation', rot);
  if(rotacionActiva) modelo.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 8000; loop: true; easing: linear');
  
  contenedor.appendChild(modelo);
  
  // Aplicar escala inicial a Modelo y Regla
  cambiarEscala(1.0);
}

// --- CAMBIAR ESCALA (OBJETO + REGLA) ---
function cambiarEscala(val) {
  escalaActual = parseFloat(val);
  const modelo = document.getElementById('modelo-3d');
  const regla = document.getElementById('regla-virtual');
  
  if(modelo) modelo.setAttribute('scale', `${escalaActual} ${escalaActual} ${escalaActual}`);
  if(regla) regla.setAttribute('scale', `${escalaActual} ${escalaActual} ${escalaActual}`);
  
  document.getElementById('scale-val').innerText = escalaActual.toFixed(1) + 'x';
  actualizarMediciones();
}

// --- ACTUALIZAR TEXTO DE MEDIDAS (UI) ---
function actualizarMediciones() {
  const base = dimensionesBase[figuraSeleccionada];
  if(!base) return;
  
  const h = Math.round(base.h * escalaActual);
  const w = Math.round(base.w * escalaActual);
  const d = Math.round(base.d * escalaActual);
  
  document.getElementById('med-h').innerText = h;
  document.getElementById('med-w').innerText = w;
  document.getElementById('med-d').innerText = d;
}

// --- CONTROLES ---
function toggleRotacion() {
  rotacionActiva = !rotacionActiva;
  const modelo = document.getElementById('modelo-3d');
  const btn = document.querySelector('.action-buttons .btn-control:first-child');
  if(modelo) {
    if(rotacionActiva) {
      modelo.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 8000; loop: true; easing: linear');
      btn.innerHTML = '‚è∏Ô∏è';
    } else {
      modelo.removeAttribute('animation');
      btn.innerHTML = '‚ñ∂Ô∏è';
    }
  }
}

function toggleRegla() {
  reglaVisible = !reglaVisible;
  const regla = document.getElementById('regla-virtual');
  if(regla) regla.setAttribute('visible', reglaVisible);
}

function configurarEventos() {
  const marker = document.querySelector('#hiro-marker');
  if(marker) {
    marker.addEventListener('markerFound', () => {
      document.getElementById('camera-status').textContent = '‚úÖ ¬°Objeto Medido!';
      document.getElementById('camera-status').className = 'status-ok';
      setTimeout(()=> document.getElementById('camera-status').style.display='none', 2000);
    });
    marker.addEventListener('markerLost', () => {
      document.getElementById('camera-status').textContent = 'üîç Buscando...';
      document.getElementById('camera-status').className = '';
      document.getElementById('camera-status').style.display='block';
    });
  }
}

function salirAR() {
  if(confirm('¬øSalir?')) location.reload();
}
function volverInicio() {
  document.getElementById('menu-overlay').style.display = 'none';
  document.getElementById('init-screen').classList.remove('hidden');
}
</script>
</body>
</html>
