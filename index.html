<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- Viewport Universal -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Will AR - Laboratorio con Reglas</title>
    
    <!-- LIBRER√çAS ESTABLES -->
    <script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://unpkg.com/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #0f0f0f;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Ajustes iPhone/Android */
        @supports (padding: env(safe-area-inset-bottom)) {
            body { padding-bottom: env(safe-area-inset-bottom); }
            #ar-controls { padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
        }

        .a-canvas {
            position: fixed !important;
            top: 0 !important; left: 0 !important;
            width: 100% !important; height: 100% !important;
            z-index: 1000;
        }

        /* Pantalla de Carga */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: white;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1); border-left: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Men√∫ */
        #menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(160deg, #2c3e50 0%, #000000 100%); 
            z-index: 5000;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: flex-start;
            overflow-y: auto; 
            padding: 20px; 
            color: white; 
            transition: transform 0.4s ease;
            -webkit-overflow-scrolling: touch;
        }

        .card {
            background: rgba(255,255,255,0.08); padding: 20px; border-radius: 16px;
            width: 95%; max-width: 420px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        h1 { margin: 0 0 5px 0; color: #3498db; font-size: 1.8rem; }
        h2 { margin: 0; font-size: 1rem; font-weight: 300; color: #bdc3c7; margin-bottom: 20px; }
        
        label { display: block; text-align: left; margin-top: 15px; margin-bottom: 5px; color: #ecf0f1; font-size: 0.85rem; }
        
        select, input[type="file"] {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3); color: white; font-size: 1rem; outline: none;
        }
        option { background: #2c3e50; color: white; }
        
        button {
            width: 100%; padding: 14px; margin-top: 15px; border-radius: 8px; 
            border: none; font-size: 1rem; font-weight: 600; cursor: pointer; 
            transition: background 0.2s;
        }
        .btn-primary { background: #2980b9; color: white; }
        .btn-start { background: #27ae60; color: white; font-size: 1.2rem; display: none; }
        .btn-exit { background: #c0392b; color: white; width: auto; padding: 10px 20px; }
        
        #qr-area { background: white; padding: 15px; border-radius: 10px; display: none; margin: 15px auto; width: fit-content; }
        
        /* AR HUD */
        #ar-controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.9); padding: 20px; 
            box-sizing: border-box; display: none; z-index: 2000; text-align: center; 
            color: white; border-top: 2px solid #3498db;
        }
        input[type=range] { width: 90%; accent-color: #3498db; margin: 10px 0; }
        #status-msg { font-size: 0.8rem; margin-top: 5px; color: #f39c12; min-height: 1.2em; }
    </style>
</head>
<body>

    <!-- CARGANDO -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Cargando Laboratorio AR...</p>
    </div>

    <!-- MEN√ö -->
    <div id="menu-overlay">
        <div class="card">
            <h1>Will AR</h1>
            <h2>Geometr√≠a con Reglas</h2>
            
            <label>1. Textura (Foto - M√°x 2MB)</label>
            <input type="file" id="imgUpload" accept="image/*" capture="environment">
            <div id="status-msg">Sin imagen</div>

            <label>2. Seleccionar Figura</label>
            <select id="figura">
                <option value="box">üì¶ Cubo (Perfecto para volumen)</option>
                <option value="sphere">‚öΩ Esfera</option>
                <option value="cylinder">üõ¢Ô∏è Cilindro</option>
                <option value="cone">üî∫ Cono</option>
                <option value="tetrahedron">üî∫ Tetraedro</option>
                <option value="dodecahedron">üíé Dodecaedro</option>
                <option value="icosahedron">‚öΩ Icosaedro</option>
                <option value="octahedron">üí† Octaedro</option>
            </select>

            <button class="btn-primary" onclick="generarConfig()">‚öôÔ∏è CONFIGURAR</button>

            <div id="qr-area"><div id="qrcode"></div></div>

            <button id="btn-iniciar" class="btn-start" onclick="iniciarAR()">üöÄ INICIAR C√ÅMARA</button>
        </div>
        
        <div style="text-align:center; max-width:420px; width:95%; font-size:0.85rem; opacity:0.7; margin-bottom:20px;">
            <p><strong>INSTRUCCIONES:</strong></p>
            <p>1. Imprime el marcador HIRO.</p>
            <a href="https://ar-js-org.github.io/AR.js/data/images/hiro.png" target="_blank" style="color:#3498db; text-decoration:underline;">Descargar Marcador</a>
        </div>
    </div>

    <!-- AR HUD -->
    <div id="ar-controls">
        <h3 id="label-figura" style="color:#3498db; margin:0 0 10px 0;">CUBO</h3>
        <p style="font-size:0.9rem; color:#bdc3c7; margin-bottom:10px;">Escala: <span id="scale-val">1.0</span> (Unidades)</p>
        
        <label>Escalar Figura (y Regla):</label>
        <input type="range" min="0.5" max="3" step="0.1" value="1" oninput="escalarTodo(this.value)">
        
        <button class="btn-exit" onclick="salirAR()">Volver</button>
    </div>

    <!-- ESCENA 3D CON REGLAS -->
    <a-scene 
        id="ar-scene"
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" 
        vr-mode-ui="enabled: false" 
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        loading-screen="enabled: false">
        
        <a-assets timeout="10000">
            <img id="textura-asset" crossorigin="anonymous" src=""> 
            <img id="textura-defecto" src="https://picsum.photos/seed/willar-math/500/500.jpg" crossorigin="anonymous">
        </a-assets>

        <a-marker 
            id="hiro-marker"
            preset="hiro" 
            smooth="true" 
            smoothCount="10">
            
            <!-- Grupo Principal: Todo lo que adentro est√© se escala junto -->
            <a-entity id="grupo-ar" position="0 0.5 0" rotation="-90 0 0">
                
                <!-- 1. MODELO 3D PRINCIPAL -->
                <a-entity 
                    id="modelo-3d"
                    animation__appear="property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutElastic; startEvents: markerFound"
                    animation__rotate="property: rotation; to: 0 360 0; dur: 10000; loop: true; easing: linear">
                </a-entity>

                <!-- 2. WIREFRAME DE GU√çA (Un poco m√°s grande para envolver la regla) -->
                <a-entity 
                    id="wireframe-guia" 
                    material="wireframe: true; color: #00ffcc; opacity: 0.2" 
                    scale="1.1 1.1 1.1">
                </a-entity>

                <!-- 3. REGLA DIGITAL: EJE X (ANCHO - ROJO) -->
                <!-- Posicionada ligeramente encima de la figura -->
                <a-entity id="ruler-x" position="0 0.6 0">
                    <!-- L√≠nea principal -->
                    <a-box position="0 0 0" width="2.2" height="0.02" depth="0.02" color="#e74c3c"></a-box>
                    <!-- Marcas de inicio y fin -->
                    <a-box position="-1 0 0" width="0.05" height="0.05" depth="0.05" color="#fff"></a-box>
                    <a-box position="1 0 0" width="0.05" height="0.05" depth="0.05" color="#fff"></a-box>
                    <!-- Texto "Ancho" -->
                    <a-text value="Ancho" position="0 0.1 0" align="center" color="#e74c3c" scale="0.5 0.5 0.5"></a-text>
                </a-entity>

                <!-- 4. REGLA DIGITAL: EJE Y (ALTO - AZUL) -->
                <!-- Posicionada a la derecha -->
                <a-entity id="ruler-y" position="1.2 0 0" rotation="0 0 90">
                    <a-box position="0 0 0" width="2.2" height="0.02" depth="0.02" color="#3498db"></a-box>
                    <!-- Marcas -->
                    <a-box position="-1 0 0" width="0.05" height="0.05" depth="0.05" color="#fff"></a-box>
                    <a-box position="1 0 0" width="0.05" height="0.05" depth="0.05" color="#fff"></a-box>
                    <!-- Texto "Alto" -->
                    <a-text value="Alto" position="0 0.1 0" align="center" color="#3498db" scale="0.5 0.5 0.5"></a-text>
                </a-entity>

            </a-entity>

            <a-text value="Will AR" position="0 1.5 0" align="center" color="#3498db" scale="1.2 1.2 1.2"></a-text>
        </a-marker>
        
        <a-entity camera look-controls="enabled: false"></a-entity>
    </a-scene>

    <script>
        let texturaData = null; 
        let figuraSeleccionada = "box";
        let arActivo = false;

        // 1. CARGA Y HTTPS
        function forceHTTPS() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                if (location.hostname.includes('github.io')) {
                    location.replace('https:' + window.location.href.substring(window.location.protocol.length));
                }
            }
        }
        window.addEventListener('load', () => {
            forceHTTPS();
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', () => {
                    setTimeout(() => {
                        document.getElementById('loading-screen').style.opacity = '0';
                        setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 500);
                    }, 500);
                });
            }
        });

        // 2. IMAGEN
        document.getElementById('imgUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            if(file.size > 2 * 1024 * 1024) { alert('M√°ximo 2MB'); this.value=''; return; }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                texturaData = event.target.result;
                document.getElementById('status-msg').innerText = "‚úÖ " + file.name;
                document.getElementById('textura-asset').setAttribute('src', texturaData);
            };
            reader.readAsDataURL(file);
        });

        // 3. QR
        function generarConfig() {
            figuraSeleccionada = document.getElementById('figura').value;
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = "";
            try {
                new QRCode(qrContainer, { text: JSON.stringify({app:'WillAR', fig:figuraSeleccionada}), width:140, height:140 });
                document.getElementById('qr-area').style.display = "block";
                document.getElementById('btn-iniciar').style.display = "block";
            } catch(e) {}
        }

        // 4. INICIAR AR
        async function iniciarAR() {
            try {
                // Permisos
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                stream.getTracks().forEach(t => t.stop());

                // Configurar Geometr√≠a
                const modelo = document.getElementById('modelo-3d');
                const wireframe = document.getElementById('wireframe-guia');
                let geoParams = { primitive: figuraSeleccionada };
                
                // Ajustes espec√≠ficos
                if(figuraSeleccionada === 'sphere') { geoParams.radius=0.7; geoParams.segmentsWidth=32; }
                else if(figuraSeleccionada === 'cylinder') { geoParams.radius=0.5; geoParams.height=1.5; }
                else if(figuraSeleccionada === 'cone') { geoParams.radiusBottom=0.6; geoParams.height=1.5; }

                modelo.setAttribute('geometry', geoParams);
                wireframe.setAttribute('geometry', geoParams);

                // Material
                let matParams = { side: 'double', metalness: 0.3, roughness: 0.5 };
                matParams.src = texturaData ? '#textura-asset' : '#textura-defecto';
                modelo.setAttribute('material', matParams);

                // UI
                arActivo = true;
                document.getElementById('menu-overlay').style.transform = "translateY(-100%)";
                document.getElementById('ar-controls').style.display = "block";
                document.getElementById('label-figura').innerText = figuraSeleccionada.toUpperCase();

            } catch(error) {
                alert('Error c√°mara: ' + error.message);
            }
        }

        // 5. ESCALAR TODO (GRUPO)
        function escalarTodo(val) {
            const v = parseFloat(val);
            // Escalamos el contenedor principal, lo que escala la figura + las reglas al mismo tiempo
            document.getElementById('grupo-ar').setAttribute('scale', `${v} ${v} ${v}`);
            
            document.getElementById('scale-val').innerText = v.toFixed(1);
        }

        function salirAR() { if(confirm('¬øVolver?')) location.reload(); }
        document.addEventListener('gesturestart', e => e.preventDefault());
    </script>
</body>
</html>
