<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>WILL AR</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar-js-org@3.4.4/aframe/build/aframe-ar.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#000; width:100vw; height:100vh; overflow:hidden; font-family:sans-serif; }
    #init { position:fixed; top:0; left:0; width:100%; height:100%; background:#1a1a2e; z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; text-align:center; padding:20px; }
    #init h1 { font-size:2.5rem; color:#3498db; margin-bottom:15px; }
    #init p { max-width:80%; margin:15px 0; line-height:1.6; color:#bdc3c7; }
    .btn { background:#2ecc71; color:white; border:none; padding:16px 40px; font-size:1.2rem; border-radius:12px; cursor:pointer; font-weight:bold; margin:10px; }
    .btn:hover { background:#27ae60; }
    #menu { position:fixed; top:0; left:0; width:100%; height:100%; background:#2c3e50; z-index:99; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; padding:20px; }
    .card { background:rgba(0,0,0,0.3); padding:25px; border-radius:15px; width:90%; max-width:400px; text-align:center; }
    select { width:100%; padding:12px; margin:15px 0; border-radius:8px; background:#34495e; color:white; border:none; }
    #file-label { display:block; background:#9b59b6; color:white; padding:12px; border-radius:8px; margin:15px 0; cursor:pointer; }
    input[type=file] { display:none; }
    #preview { max-width:100%; max-height:150px; margin-top:15px; border-radius:8px; display:none; }
    #ar-scene { position:fixed; top:0; left:0; width:100%; height:100%; z-index:1; display:none; }
    #controls { position:fixed; bottom:15px; left:0; width:100%; text-align:center; z-index:10; display:none; }
    .ctrl-btn { background:#3498db; color:white; border:none; width:50px; height:50px; border-radius:50%; font-size:1.3rem; margin:0 8px; }
    #exit { position:fixed; top:15px; right:15px; background:#e74c3c; color:white; width:45px; height:45px; border-radius:50%; border:none; font-size:1.2rem; z-index:10; display:none; }
    #status { position:fixed; top:15px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:#f39c12; padding:8px 20px; border-radius:20px; z-index:10; display:none; }
    #status.ok { color:#2ecc71; }
  </style>
</head>
<body>
  <!-- Pantalla inicial -->
  <div id="init">
    <h1>üî¨ WILL AR</h1>
    <p>Apunta tu c√°mara al marcador HIRO para ver figuras 3D</p>
    <button class="btn" id="start-btn">‚úÖ INICIAR C√ÅMARA</button>
    <p style="margin-top:25px; font-size:0.9rem;">
      <a href="https://ar-js-org.github.io/AR.js/data/images/hiro.png" target="_blank" style="color:#3498db;">Descargar marcador HIRO</a>
    </p>
  </div>

  <!-- Men√∫ de configuraci√≥n -->
  <div id="menu">
    <div class="card">
      <h2 style="color:#3498db; margin-bottom:20px;">‚öôÔ∏è CONFIGURAR</h2>
      
      <label>üî∑ Figura</label>
      <select id="figura">
        <option value="box">Cubo</option>
        <option value="sphere">Esfera</option>
        <option value="cylinder">Cilindro</option>
        <option value="cone">Cono</option>
      </select>
      
      <label for="file-input" class="file-label" id="file-label">üìÅ Subir Imagen (JPG/PNG)</label>
      <input type="file" id="file-input" accept="image/jpeg,image/png">
      <img id="preview" alt="Vista previa">
      
      <button class="btn" id="go-ar" style="background:#3498db; margin-top:20px;">üöÄ INICIAR AR</button>
      <button class="btn" id="back-btn" style="background:#e74c3c;">üîô Atr√°s</button>
    </div>
  </div>

  <!-- Escena AR (inicialmente vac√≠a) -->
  <div id="ar-scene"></div>

  <!-- Controles -->
  <div id="controls">
    <button class="ctrl-btn" id="btn-rot">‚è∏Ô∏è</button>
    <button class="ctrl-btn" id="btn-info">‚ÑπÔ∏è</button>
  </div>
  <button id="exit">‚úï</button>
  <div id="status">üîç Buscando marcador...</div>

  <script>
    let textura = null;
    let figura = 'box';
    let rotando = true;
    let sceneReady = false;
    let cameraStream = null;

    // 1. INICIAR: Solicitar permisos SOLO al hacer clic (gesture initiated)
    document.getElementById('start-btn').addEventListener('click', async () => {
      try {
        // Esto funciona porque es iniciado por clic del usuario
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
        
        // Detener stream temporalmente (AR.js lo reiniciar√°)
        cameraStream.getTracks().forEach(track => track.stop());
        
        document.getElementById('init').style.display = 'none';
        document.getElementById('menu').style.display = 'flex';
      } catch (err) {
        alert('Error c√°mara: ' + err.name + '\n\nPermite el permiso cuando el navegador lo solicite');
      }
    });

    // 2. SUBIR IMAGEN (funciona normalmente)
    document.getElementById('file-input').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 5 * 1024 * 1024) {
        alert('M√°ximo 5MB');
        e.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = ev => {
        textura = ev.target.result;
        document.getElementById('preview').src = textura;
        document.getElementById('preview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    // 3. IR A AR: Construir escena DIN√ÅMICAMENTE despu√©s de permisos
    document.getElementById('go-ar').addEventListener('click', () => {
      figura = document.getElementById('figura').value;
      document.getElementById('menu').style.display = 'none';
      
      // Construir escena SOLO ahora (no al cargar la p√°gina)
      construirEscena();
      
      document.getElementById('ar-scene').style.display = 'block';
      document.getElementById('controls').style.display = 'block';
      document.getElementById('exit').style.display = 'block';
      document.getElementById('status').style.display = 'block';
    });

    document.getElementById('back-btn').addEventListener('click', () => {
      document.getElementById('menu').style.display = 'none';
      document.getElementById('init').style.display = 'flex';
    });

    document.getElementById('exit').addEventListener('click', () => {
      if (confirm('¬øSalir?')) location.reload();
    });

    // 4. FUNCIONES DE CONTROL
    document.getElementById('btn-rot').addEventListener('click', () => {
      rotando = !rotando;
      const modelo = document.getElementById('modelo');
      if (modelo) {
        if (rotando) {
          modelo.setAttribute('animation', 'property: rotation; to: 0 360 0; dur: 8000; loop: true; easing: linear');
          document.getElementById('btn-rot').innerHTML = '‚è∏Ô∏è';
        } else {
          modelo.removeAttribute('animation');
          document.getElementById('btn-rot').innerHTML = '‚ñ∂Ô∏è';
        }
      }
    });

    // 5. CONSTRUIR ESCENA (clave: se ejecuta DESPU√âS de permisos)
    function construirEscena() {
      const container = document.getElementById('ar-scene');
      
      // HTML m√≠nimo necesario para AR.js
      container.innerHTML = `
        <a-scene embedded arjs="sourceType: webcam; sourceWidth: 1280; sourceHeight: 720; debugUIEnabled: false;"
                 style="position:absolute; width:100%; height:100%;">
          
          <a-assets>
            <img id="tex" src="${textura || ''}">
          </a-assets>
          
          <a-marker preset="hiro">
            <a-entity id="modelo" 
                      geometry="primitive:${getPrimitive(figura)}"
                      material="${textura ? 'src:#tex' : 'color:#4ECDC4'}"
                      position="0 0.5 0"
                      scale="1 1 1"
                      animation="property: rotation; to: 0 360 0; dur: 8000; loop: true; easing: linear">
            </a-entity>
          </a-marker>
          
          <a-entity camera></a-entity>
        </a-scene>
      `;
      
      // Eventos de marcador
      setTimeout(() => {
        const marker = document.querySelector('a-marker');
        if (marker) {
          marker.addEventListener('markerFound', () => {
            document.getElementById('status').textContent = '‚úÖ ¬°Listo!';
            document.getElementById('status').className = 'ok';
            setTimeout(() => { document.getElementById('status').style.display = 'none'; }, 2000);
          });
          
          marker.addEventListener('markerLost', () => {
            document.getElementById('status').textContent = 'üîç Buscando marcador...';
            document.getElementById('status').className = '';
            document.getElementById('status').style.display = 'block';
          });
        }
      }, 1000);
    }

    function getPrimitive(fig) {
      return fig === 'box' ? 'box' : 
             fig === 'sphere' ? 'sphere; radius:0.5' :
             fig === 'cylinder' ? 'cylinder; radius:0.35; height:1' :
             fig === 'cone' ? 'cone; radiusBottom:0.35; radiusTop:0; height:1' : 'box';
    }
  </script>
</body>
</html>
